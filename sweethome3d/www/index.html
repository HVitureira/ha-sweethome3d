<!--
   index.html 
   
   Sweet Home 3D, Copyright (c) 2024 Space Mushrooms <info@sweethome3d.com>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.
 
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-->
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="minimal-ui, user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <title>Sweet Home 3D JS</title>
  <script type="text/javascript" src="lib/big.min.js"></script>
  <script type="text/javascript" src="lib/gl-matrix-min.js"></script>
  <script type="text/javascript" src="lib/jszip.min.js"></script>
  <script type="text/javascript" src="lib/jsXmlSaxParser.min.js"></script>
  <script type="text/javascript" src="lib/core.min.js"></script>
  <script type="text/javascript" src="lib/geom.min.js"></script>
  <script type="text/javascript" src="lib/stroke.min.js"></script>
  <script type="text/javascript" src="lib/swingundo.min.js"></script>
  <script type="text/javascript" src="lib/batik-svgpathparser.min.js"></script>
  <script type="text/javascript" src="lib/triangulator.min.js"></script>
  <script type="text/javascript" src="lib/graphics2d.min.js"></script>
  <script type="text/javascript" src="lib/recorderworker.min.js" id="recorder-worker"></script>
  <script type="text/javascript" src="lib/sweethome3d.min.js"></script>
<!-- OBJ Exporter for Unity Integration -->
<script type="text/javascript" src="lib/objDefaults.js"></script>
<script type="text/javascript" src="lib/objExporter.js?v=2.5"></script>
<script type="text/javascript" src="lib/obj-exporter-integration.js"></script>
<script type="text/javascript" src="lib/unity-export-utils.js"></script>
<!-- TODO: CHECK LATER - Canvas 2D renderer not working, commented out for now -->
<!-- <script src="lib/effect-radius-renderer.js"></script> -->

  <link rel="stylesheet" type="text/css" href="lib/sweethome3djs.css">
  <style type="text/css">
    html,
    body {
      overflow-x: hidden;
      overflow-y: hidden;
    }

    body {
      position: relative;
      margin: 0px;
      height: 100%;
      -ms-user-select: none;
      user-select: none;
      touch-action: none;
    }

    #home-plan::selection {
      background: #0042E0;
    }

    #application-menu-toolbar,
    #home-pane-toolbar,
    #catalog-furniture-pane,
    #furniture-catalog,
    #catalog-furniture-splitter,
    #furniture-view,
    #furniture-plan-splitter,
    #plan-3D-view-pane,
    #home-plan,
    #plan-3D-view-splitter,
    #home-3D-view {
      position: absolute;
    }

    /*
 * No-touch devices common CSS
 */
    #application-menu-toolbar {
      display: none;
    }

    #home-pane-toolbar {
      top: 0;
      height: 30px;
      white-space: nowrap;
    }

    #catalog-furniture-pane {
      top: 30px;
      left: 0;
      width: 296px;
      height: calc(100% - 30px);
      overflow: hidden;
    }

    #furniture-catalog {
      height: 70%;
      width: 100%;
      overflow-y: hidden;
    }

    #furniture-catalog-list {
      height: calc(100% - 3.3em);
      width: 100%;
      overflow-y: scroll;
    }

    #catalog-furniture-splitter {
      top: 70%;
      left: 0;
      width: 100%;
    }

    #furniture-view {
      top: calc(70% + 4px);
      width: 100%;
      height: calc(30% - 4px);
      box-sizing: border-box;
    }

    #furniture-view .tree-table {
      width: 100%;
      height: 100%;
      overflow-y: hidden;
    }

    .pane-splitter.vertical::after {
      transform: rotate(90deg);
      bottom: initial;
      top: 50%;
    }

    #furniture-plan-splitter {
      top: 30px;
      left: 296px;
      height: calc(100% - 30px);
    }

    #plan-3D-view-pane {
      top: 30px;
      left: 300px;
      width: calc(100% - 300px);
      height: calc(100% - 30px);
    }

    #home-plan {
      width: 100%;
      height: calc(50% - 2px);
      font-family: sans-serif;
      border-top: 1px solid gray;
      border-bottom: 1px solid gray;
    }

    #plan-3D-view-splitter {
      top: calc(50% - 2px);
      left: 0;
      width: 100%;
    }

    #home-3D-view {
      top: calc(50% + 2px);
      width: 100%;
      height: calc(50% - 2px);
      border-bottom: 1px solid gray;
    }

    #home-plan:focus,
    #home-3D-view:focus {
      outline: none;
    }

    @media (orientation: portrait) {

      #catalog-furniture-pane {
        width: 160px;
      }

      #furniture-plan-splitter {
        left: 160px;
      }

      #plan-3D-view-pane {
        left: 164px;
        width: calc(100% - 164px);
      }
    }

    /*
 * Touch devices common CSS - ignored by IE (coarse point query required for some Android devices)
 */
    @media (hover: none),
    (pointer: coarse) {

      body {
        margin: 5px;
        height: calc(100% - 10px);
      }

      /* No scroll bars under Chrome */
      ::-webkit-scrollbar {
        display: none;
      }

      #application-menu-toolbar {
        display: flex;
        top: calc(100% - 40px);
        height: 40px;
        width: calc(28px + 15px);
      }

      #home-pane-toolbar {
        left: calc(28px + 20px);
        top: calc(100% - 40px);
        height: 40px;
        width: calc(100% - 28px - 20px);
      }

      @media (max-width: 940px) {
        #application-menu-toolbar {
          width: calc(28px + 11px);
        }

        #home-pane-toolbar {
          left: calc(28px + 13px);
          width: calc(100% - 28px - 13px);
        }
      }

      .toolbar .toolbar-button {
        margin-top: 0px;
        height: calc(100% - 2px);
      }

      #furniture-plan-splitter {
        width: 8px;
      }

      #catalog-furniture-splitter,
      #plan-3D-view-splitter {
        height: 8px;
      }

      #catalog-furniture-pane {
        top: 0;
        height: calc(100% - 42px);
      }

      #furniture-plan-splitter {
        top: 0;
        height: calc(100% - 40px);
      }

      #plan-3D-view-pane {
        top: 0;
        height: calc(100% - 41px);
      }

      #catalog-furniture-pane {
        border-bottom: 1px solid gray;
      }

      #home-plan {
        width: calc(100% - 1px);
        height: calc(50% - 4px);
        border-right: 1px solid gray;
      }

      #home-3D-view {
        top: calc(50% + 4px);
        width: calc(100% - 1px);
        height: calc(50% - 4px);
        border-right: 1px solid gray;
      }

      .popup-menu .item * {
        font-size: 17px;
      }

      .tree-table {
        font-size: 0.85em;
      }

      /* Small touch devices like smartphones */
      @media (max-width: 743px),
      (max-height: 511px) {
        .pane-splitter {
          display: none;
        }

        #furniture-catalog {
          height: 100%;
        }

        #furniture-catalog-list {
          height: calc(100% - 2.5em);
          left: 0;
        }

        #catalog-furniture-splitter,
        #furniture-view {
          display: none;
        }

        #furniture-view {
          display: none;
        }

        @media (orientation: portrait),
        (max-aspect-ratio: 5/4) {
          #furniture-filter {
            height: 0px;
          }


          #plan-3D-view-pane {
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 80px - 40px);
          }

          #home-3D-view {
            top: 0;
            width: calc(100% - 2px);
            height: calc(50% - 2px - 4px);
            border: 1px solid gray;
          }

          #plan-3D-view-splitter {
            display: initial;
            top: calc(50% - 4px);
            left: 0;
            width: calc(100%);
            height: 8px;
          }

          #home-plan {
            top: calc(50% - 1px + 4px);
            width: calc(100% - 2px);
            height: calc(50% - 4px);
            border: 1px solid gray;
          }

          /* Funiture catalog horizontal layout */

          #catalog-furniture-pane {
            top: calc(100% - 40px - 80px);
            left: 0;
            width: calc(100% - 2px);
            height: 79px;
            border-top: 0;
            overflow-x: scroll;
            overflow-y: hidden;
          }

          #furniture-catalog {
            width: 100%;
          }

          #furniture-catalog-list {
            width: 100%;
            height: 100%;
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
          }

          .furniture-category-label {
            display: none;
          }

          .furniture {
            margin-top: 0px;
            margin-bottom: 0px;
            white-space: normal;
          }

          .furniture>.furniture-icon {
            top: 3px;
          }

          .furniture>.furniture-label {
            z-index: 2;
            text-shadow: white 0px -2px;
          }

          .furniture-category-separator {
            display: inline-block;
            height: 80px;
            padding-right: 10px;
            margin-right: 10px;
            border-right: dashed 1px rgba(0, 0, 0, 0.4);
          }
        }

        @media (orientation: landscape) and (min-aspect-ratio: 5/4) {

          #catalog-furniture-pane {
            top: 0;
            left: 0;
            width: 150px;
            height: calc(100% - 40px - 2px);
            overflow-x: hidden;
            overflow-y: scroll;
          }

          #plan-3D-view-pane {
            top: 0;
            left: 150px;
            width: calc(100% - 150px);
            height: calc(100% - 40px);
          }

          #home-plan {
            top: 0;
            width: calc(50% - 4px);
            height: calc(100% - 2px);
            border: 1px solid gray;
          }

          #plan-3D-view-splitter {
            display: initial;
            top: 0;
            left: calc(50% - 4px);
            width: 8px;
            height: calc(100%);
          }

          #home-3D-view {
            top: 0;
            left: calc(50% + 4px);
            width: calc(50% - 4px);
            height: calc(100% - 2px);
            border: 1px solid gray;
            border-left: 0px;
          }
        }
      }
    }

    /* Hide optional buttons when screen is too small */
    @media (max-width: 712px) {

      #home-pane-toolbar .toolbar-optional {
        display: none;
      }
    }

    @media (hover: none),
    (pointer: coarse) {
      @media (max-width: 800px) {

        #home-pane-toolbar .toolbar-optional {
          display: none;
        }
      }
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #home-plan canvas,
      #home-3D-view {
        visibility: visible;
        width: 100% !important;
        height: auto !important;
      }

      #plan-3D-view-pane {
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
    }
  </style>
</head>

<body>

  <div id="home-pane">
    <div id="application-menu-toolbar" class="toolbar"></div>
    <div id="home-pane-toolbar" class="toolbar new-home open save save-as"></div>

    <div id="catalog-furniture-pane">
      <div id="furniture-catalog" tabindex="-1">
        <div id="furniture-catalog-list" class="furniture-catalog-list"></div>
      </div>
      <div id="catalog-furniture-splitter" class="pane-splitter"></div>
      <div id="furniture-view" tabindex="-1"></div>
    </div>

    <div id="furniture-plan-splitter" class="pane-splitter"></div>

    <div id="plan-3D-view-pane">
      <div id="home-plan" style="background-color: #FFFFFF; color: #000000;" tabindex="1"><select
          id="level-selector"></select></div>
      <div id="plan-3D-view-splitter" class="pane-splitter"></div>
      <canvas id="home-3D-view" style="background-color: #CCCCCC;" tabindex="2"></canvas>
    </div>
  </div>

  <div id="home-furniture-dialog-template" class="dialog-template">
    <div class="home-furniture-dialog">
      <h3 class="card" data-name="name-and-price-title"></h3>
      <div data-name="name-and-price-panel" class="card label-input-grid">
        <div class="label-cell">
          <div data-name="name-label">@{HomeFurniturePanel.nameLabel.text}</div>
        </div>
        <div>
          <input name="name-input" size="50" type="text" />

          <label>
            <input type="checkbox" name="name-visible-checkbox" />
            <span>@{HomeFurniturePanel.nameVisibleCheckBox.text}</span>
          </label>
        </div>

        <div class="label-cell">
          <div data-name="description-label">@{HomeFurniturePanel.descriptionLabel.text}</div>
        </div>
        <div>
          <input name="description-input" size="50" type="text" />
        </div>

          <!-- HOME ASSISTANT ENTITY ID FIELD -->
        <div class="label-cell ha-only" data-name="ha-entity-label" style="display:none;">
          <div>üè† HA Entity ID:</div>
        </div>
        <div class="ha-only" data-name="ha-entity-input-container" style="display:none;">
          <input name="ha-entity-input" size="50" type="text" placeholder="sensor.living_room_temperature"
            pattern="[a-z_]+\.[a-z0-9_]+" title="Format: domain.entity_name (e.g., sensor.living_room_temperature)" />
          <div style="font-size: 0.85em; color: #666; margin-top: 0.3em;">
            Enter the Home Assistant entity_id for this smart device
          </div>
        </div>

        <div data-name="ha-effect-radius-container" style="display:none; margin-top: 15px;">
          <div style="color: #666; font-size: 12px; margin-bottom: 5px; font-weight: 500;">
            üì° Effect Radius
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input 
              data-name="ha-effect-radius-slider" 
              type="range" 
              min="0.5" 
              max="15" 
              step="0.5" 
              value="3.0"
              style="flex: 1; cursor: pointer; height: 6px;"
            />
            <span 
              data-name="ha-effect-radius-value" 
              style="min-width: 50px; text-align: right; font-family: monospace; font-weight: bold; color: #0066cc;"
            >3.0m</span>
          </div>
        </div>

        <div class="label-cell">
          <div data-name="price-label">@{HomeFurniturePanel.priceLabel.text}</div>
        </div>
        <div>
          <span data-name="price-input"></span>

          <span>@{HomeFurniturePanel.valueAddedTaxPercentageLabel.text}</span>
          <span data-name="value-added-tax-percentage-input"></span>
        </div>
      </div>

      <br />
      <div class="columns">
        <div class="location-column">
          <h3 class="card">@{HomeFurniturePanel.locationPanel.title}</h3>
          <div class="location-panel card label-input-grid">
            <div data-name="x-label" class="label-cell"></div>
            <div>
              <span data-name="x-input"></span>
            </div>

            <div data-name="y-label" class="label-cell"></div>
            <div>
              <span data-name="y-input"></span>
            </div>

            <div data-name="elevation-label" class="label-cell"></div>
            <div>
              <span data-name="elevation-input"></span>
            </div>

            <label title="@{HomeFurniturePanel.mirroredModelCheckBox.tooltip}" class="whole-line">
              <input type="checkbox" name="mirrored-model-checkbox" />
              <span>@{HomeFurniturePanel.mirroredModelCheckBox.text}</span>
            </label>

            <label title="@{HomeFurniturePanel.basePlanItemCheckBox.tooltip}" class="whole-line">
              <input type="checkbox" name="base-plan-item-checkbox" />
              <span>@{HomeFurniturePanel.basePlanItemCheckBox.text}</span>
            </label>
          </div>

          <br />
          <h3 class="card">@{HomeFurniturePanel.colorAndTexturePanel.title}</h3>
          <div data-name="paint-panel" class="card label-input-grid">
            <div>
              <label>
                <input type="radio" name="paint-checkbox" value="default">
                @{HomeFurniturePanel.defaultColorAndTextureRadioButton.text}
              </label>
            </div>
            <div></div>

            <div>
              <label>
                <input type="radio" name="paint-checkbox" value="color">
                @{HomeFurniturePanel.colorRadioButton.text}
              </label>
            </div>
            <div data-name="color-button"></div>

            <div>
              <label>
                <input type="radio" name="paint-checkbox" value="texture">
                @{HomeFurniturePanel.textureRadioButton.text}
              </label>
            </div>
            <div data-name="texture-component"></div>

            <div>
              <label>
                <input type="radio" name="paint-checkbox" value="MODEL_MATERIALS">
                @{HomeFurniturePanel.modelMaterialsRadioButton.text}
              </label>
            </div>
            <div data-name="material-component"></div>
          </div>
        </div>

        <div class="orientation-column">
          <h3 class="card">@{HomeFurniturePanel.orientationPanel.title}</h3>
          <div data-name="orientation-panel" class="card label-input-grid">
            <div class="whole-line" data-name="vertical-rotation-label">@{HomeFurniturePanel.verticalRotationLabel.text}
            </div>

            <div class="label-cell" data-name="angle-label">@{HomeFurniturePanel.angleLabel.text}</div>
            <div>
              <span data-name="angle-input"></span>
            </div>

            <div class="whole-line" data-name="horizontal-rotation-label">
              @{HomeFurniturePanel.horizontalRotationLabel.text}</div>

            <label class="label-cell">
              <input type="radio" name="horizontal-rotation-radio" value="PITCH" />
              @{HomeFurniturePanel.pitchRadioButton.text}
            </label>
            <div>
              <span data-name="pitch-input"></span>
            </div>

            <label class="label-cell">
              <input type="radio" name="horizontal-rotation-radio" value="ROLL" />
              @{HomeFurniturePanel.rollRadioButton.text}
            </label>
            <div>
              <span data-name="roll-input"></span>
            </div>

            <div class="whole-line" data-name="furniture-orientation-image">
            </div>
          </div>
        </div>

        <div>
          <h3 class="card">@{HomeFurniturePanel.sizePanel.title}</h3>
          <div data-name="size-panel" class="card label-input-grid">
            <div data-name="width-label" class="label-cell"></div>
            <div>
              <span data-name="width-input"></span>
            </div>

            <div data-name="depth-label" class="label-cell"></div>
            <div>
              <span data-name="depth-input"></span>
            </div>

            <div data-name="height-label" class="label-cell"></div>
            <div>
              <span data-name="height-input"></span>
            </div>

            <label class="whole-line">
              <input type="checkbox" name="keep-proportions-checkbox" />
              <span>@{ImportedFurnitureWizardStepsPanel.keepProportionsCheckBox.text}</span>
            </label>

            <div class="whole-line" style="text-align: center">
              <button name="model-transformations-button">@{HomeFurniturePanel.modelTransformationsButton.text}</button>
            </div>
          </div>

          <br />
          <h3 class="card">@{HomeFurniturePanel.shininessPanel.title}</h3>
          <div data-name="shininess-panel" class="card label-input-grid">
            <div>
              <label>
                <input name="shininess-radio" type="radio" value="DEFAULT" />
                <span>@{HomeFurniturePanel.defaultShininessRadioButton.text}</span>
              </label>
            </div>

            <div>
              <label>
                <input name="shininess-radio" type="radio" value="MATT" />
                <span>@{HomeFurniturePanel.mattRadioButton.text}</span>
              </label>
            </div>

            <div>
              <label>
                <input name="shininess-radio" type="radio" value="SHINY" />
                <span>@{HomeFurniturePanel.shinyRadioButton.text}</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <br />
      <div class="card visibility">
        <label>
          <input type="checkbox" name="visible-checkbox" />
          <span>@{HomeFurniturePanel.visibleCheckBox.text}</span>
        </label>
      </div>
    </div>
  </div>


  <div id="observer-camera-dialog-template" class="dialog-template">
    <div class="observer-camera-dialog">
      <div class="columns">
        <div>
          <h3 class="card">@{ObserverCameraPanel.locationPanel.title}</h3>
          <div data-name="location-panel" class="card label-input-grid">
            <div data-name="x-label" class="label-cell"></div>
            <div>
              <span data-name="x-input"></span>
            </div>

            <div data-name="y-label" class="label-cell"></div>
            <div>
              <span data-name="y-input"></span>
            </div>

            <div data-name="elevation-label" class="label-cell"></div>
            <div>
              <span data-name="elevation-input"></span>
            </div>
          </div>
        </div>

        <div>
          <h3 class="card">@{ObserverCameraPanel.anglesPanel.title}</h3>
          <div data-name="angles-panel" class="card label-input-grid">

            <div class="label-cell">@{ObserverCameraPanel.yawLabel.text}</div>
            <div>
              <span data-name="yaw-input"></span>
            </div>

            <div class="label-cell">@{ObserverCameraPanel.pitchLabel.text}</div>
            <div>
              <span data-name="pitch-input"></span>
            </div>

            <div class="label-cell">@{ObserverCameraPanel.fieldOfViewLabel.text}</div>
            <div>
              <span data-name="field-of-view-input"></span>
            </div>
          </div>
        </div>
      </div>

      <br />
      <label>
        <input type="checkbox" name="adjust-observer-camera-elevation-checkbox" />
        @{ObserverCameraPanel.adjustObserverCameraElevationCheckBox.text}
      </label>
    </div>
  </div>

  <div id="home-3Dattributes-dialog-template" class="dialog-template">
    <div class="home-3Dattributes-dialog">
      <div class="columns">
        <div class="column1">
          <h3 class="card">@{Home3DAttributesPanel.groundPanel.title}</h3>
          <div class="card label-input-grid">
            <div>
              <label>
                <input type="radio" name="ground-color-and-texture-choice" value="COLORED">
                @{Home3DAttributesPanel.groundColorRadioButton.text}
              </label>
            </div>
            <div data-name="ground-color-button"></div>

            <div>
              <label>
                <input type="radio" name="ground-color-and-texture-choice" value="TEXTURED">
                @{Home3DAttributesPanel.groundTextureRadioButton.text}
              </label>
            </div>
            <div data-name="ground-texture-component"></div>

            <div class="whole-line">
              <label>
                <input type="checkbox" name="background-image-visible-on-ground-3D-checkbox" />
                @{Home3DAttributesPanel.backgroundImageVisibleOnGround3DCheckBox.text}
              </label>
            </div>
          </div>
        </div>
        <div class="column2">
          <h3 class="card">@{Home3DAttributesPanel.skyPanel.title}</h3>
          <div class="card label-input-grid">
            <div>
              <label>
                <input type="radio" name="sky-color-and-texture-choice" value="COLORED">
                @{Home3DAttributesPanel.skyColorRadioButton.text}
              </label>
            </div>
            <div data-name="sky-color-button"></div>

            <div>
              <label>
                <input type="radio" name="sky-color-and-texture-choice" value="TEXTURED">
                @{Home3DAttributesPanel.skyTextureRadioButton.text}
              </label>
            </div>
            <div data-name="sky-texture-component"></div>
          </div>
        </div>
      </div>

      <br />
      <h3 class="card">@{Home3DAttributesPanel.renderingPanel.title}</h3>
      <div class="card label-input-grid">
        <div>
          @{Home3DAttributesPanel.brightnessLabel.text}
        </div>
        <div>
          <input type="range" name="brightness-slider" min="0" max="255" list="home-3Dattributes-brightness-list" />
          <datalist id="home-3Dattributes-brightness-list"></datalist>
          <div class="slider-labels">
            <div>@{Home3DAttributesPanel.darkLabel.text}</div>
            <div>@{Home3DAttributesPanel.brightLabel.text}</div>
          </div>
        </div>

        <div>
          @{Home3DAttributesPanel.wallsTransparencyLabel.text}
        </div>
        <div>
          <input type="range" name="walls-transparency-slider" min="0" max="255"
            list="home-3Dattributes-walls-transparency-list" />
          <datalist id="home-3Dattributes-walls-transparency-list"></datalist>
          <div class="slider-labels">
            <div>@{Home3DAttributesPanel.opaqueLabel.text}</div>
            <div>@{Home3DAttributesPanel.invisibleLabel.text}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="compass-dialog-template" class="dialog-template">
    <div class="compass-dialog">
      <h3 class="card">@{CompassPanel.compassRosePanel.title}</h3>
      <div class="card label-input-grid double">
        <span data-name="x-label" class="label-cell"></span>
        <span data-name="x-input"></span>

        <label class="label-and-input">
          <input type="checkbox" name="visible-checkbox" />
          <span>@{CompassPanel.visibleCheckBox.text}</span>
        </label>

        <span data-name="y-label" class="label-cell"></span>
        <span data-name="y-input"></span>

        <span data-name="diameter-label" class="label-cell"></span>
        <span data-name="diameter-input"></span>
      </div>

      <br />
      <h3 class="card">@{CompassPanel.geographicLocationPanel.title}</h3>
      <div class="card label-input-grid double">
        <span class="label-cell">@{CompassPanel.latitudeLabel.text}</span>
        <span data-name="latitude-input"></span>

        <span class="label-cell">@{CompassPanel.northDirectionLabel.text}</span>
        <span>
          <span data-name="north-direction-input"></span>
          <canvas data-name="compass-preview">
          </canvas>
        </span>

        <span class="label-cell">@{CompassPanel.longitudeLabel.text}</span>
        <span data-name="longitude-input"></span>
      </div>
    </div>
  </div>

  <div id="level-dialog-template" class="dialog-template">
    <div class="level-dialog">
      <div class="label-input-grid">
        <span></span>
        <label>
          <input type="checkbox" name="viewable-checkbox" />
          <span>@{LevelPanel.viewableCheckBox.text}</span>
        </label>

        <span class="label-cell">@{LevelPanel.nameLabel.text}</span>
        <span><input name="name-input" type="text" /></span>

        <span data-name="elevation-label" class="label-cell"></span>
        <span>
          <span data-name="elevation-input"></span>
        </span>

        <span data-name="floor-thickness-label" class="label-cell"></span>
        <span>
          <span data-name="floor-thickness-input"></span>
        </span>

        <span data-name="height-label" class="label-cell"></span>
        <span>
          <span data-name="height-input"></span>
        </span>
      </div>

      <hr />
      <div>@{LevelPanel.levelsSummaryLabel.text}</div>
      <br />
      <div class="levels-summary">
        <table data-name="levels-table">
          <thead>
            <tr>
              <th>@{LevelPanel.nameColumn}</th>
              <th>@{LevelPanel.elevationColumn}</th>
              <th>@{LevelPanel.floorThicknessColumn}</th>
              <th>@{LevelPanel.heightColumn}</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="levels-elevation-index-buttons">
          <button name="increase-elevation-index-button"></button>
          <br />
          <button name="decrease-elevation-index-button"></button>
        </div>
      </div>
    </div>
  </div>

  <div id="wall-dialog-template" class="dialog-template">
    <div class="wall-dialog">
      <h3 class="card">@{WallPanel.startPointPanel.title}</h3>
      <div class="card label-input-grid double">
        <span data-name="x-start-label"></span>
        <span data-name="x-start-input"></span>
        <span data-name="y-start-label"></span>
        <span data-name="y-start-input"></span>
      </div>

      <br />
      <h3 class="card">@{WallPanel.endPointPanel.title}</h3>
      <div class="card label-input-grid double">
        <span data-name="x-end-label"></span>
        <span data-name="x-end-input"></span>
        <span data-name="y-end-label"></span>
        <span data-name="y-end-input"></span>
        <span class="whole-line">
          <span data-name="distance-to-end-point-label"></span>
          <span data-name="distance-to-end-point-input"></span>
        </span>
      </div>

      <br />
      <div class="columns-2">
        <div class="column1">
          <h3 class="card">@{WallPanel.leftSidePanel.title}</h3>
          <div class="color-and-texture-panel card label-input-grid">
            <div>
              <label>
                <input type="radio" name="left-side-color-and-texture-choice" value="COLORED">
                @{WallPanel.leftSideColorRadioButton.text}
              </label>
            </div>
            <div data-name="left-side-color-button"></div>

            <div>
              <label>
                <input type="radio" name="left-side-color-and-texture-choice" value="TEXTURED">
                @{WallPanel.leftSideTextureRadioButton.text}
              </label>
            </div>
            <div data-name="left-side-texture-component"></div>

            <div class="whole-line">
              <hr />
            </div>

            <label>
              <input type="radio" name="left-side-shininess-choice" value="0">
              @{WallPanel.leftSideMattRadioButton.text}
            </label>
            <label>
              <input type="radio" name="left-side-shininess-choice" value="0.25">
              @{WallPanel.leftSideShinyRadioButton.text}
            </label>

            <div class="whole-line" style="text-align: center">
              <button name="left-side-modify-baseboard-button"></button>
            </div>
          </div>
        </div>

        <div class="column2">
          <h3 class="card">@{WallPanel.rightSidePanel.title}</h3>
          <div class="color-and-texture-panel card label-input-grid">
            <div>
              <label>
                <input type="radio" name="right-side-color-and-texture-choice" value="COLORED">
                @{WallPanel.rightSideColorRadioButton.text}
              </label>
            </div>
            <div data-name="right-side-color-button"></div>

            <div>
              <label>
                <input type="radio" name="right-side-color-and-texture-choice" value="TEXTURED">
                @{WallPanel.rightSideTextureRadioButton.text}
              </label>
            </div>
            <div data-name="right-side-texture-component"></div>

            <div class="whole-line">
              <hr />
            </div>

            <label>
              <input type="radio" name="right-side-shininess-choice" value="0">
              @{WallPanel.rightSideMattRadioButton.text}
            </label>
            <label>
              <input type="radio" name="right-side-shininess-choice" value="0.25">
              @{WallPanel.rightSideShinyRadioButton.text}
            </label>

            <div class="whole-line" style="text-align: center">
              <button name="right-side-modify-baseboard-button"></button>
            </div>
          </div>
        </div>
      </div>

      <br />
      <h3 class="card">@{WallPanel.topPanel.title}</h3>
      <div class="card label-input-grid">
        <span>@{WallPanel.patternLabel.text}</span>
        <div data-name="pattern-select"></div>

        <span>@{WallPanel.topColorLabel.text}</span>
        <span>
          <label>
            <input type="radio" name="top-color-choice" value="DEFAULT">
            @{WallPanel.topDefaultColorRadioButton.text}
          </label>
          <label>
            <input type="radio" name="top-color-choice" value="COLORED">
            @{WallPanel.topColorRadioButton.text}
            <span data-name="top-color-button"></span>
          </label>
        </span>
      </div>

      <br />
      <h3 class="card">@{WallPanel.heightPanel.title}</h3>
      <div class="card">
        <div class="columns-2">
          <div class="column1">

            <div>
              <label>
                <input type="radio" name="wall-shape-choice" value="RECTANGULAR_WALL">
                @{WallPanel.rectangularWallRadioButton.text}
              </label>
            </div>
            <br />

            <div class="label-input-grid">
              <span data-name="rectangular-wall-height-label" class="label-cell"></span>
              <span data-name="rectangular-wall-height-input"></span>
            </div>
          </div>

          <div class="column2">
            <div>
              <label class="label-and-input">
                <input type="radio" name="wall-shape-choice" value="SLOPING_WALL">
                @{WallPanel.slopingWallRadioButton.text}
              </label>
            </div>
            <br />

            <div class="label-input-grid">
              <span class="label-cell">@{WallPanel.slopingWallHeightAtStartLabel.text}</span>
              <span data-name="sloping-wall-height-at-start-input"></span>
              <span class="label-cell">@{WallPanel.slopingWallHeightAtEndLabel.text}</span>
              <span data-name="sloping-wall-height-at-end-input"></span>
            </div>
          </div>
        </div>
      </div>

      <br />
      <div class="card label-input-grid double">
        <span data-name="thickness-label" class="label-cell"></span>
        <span data-name="thickness-input"></span>
        <span data-name="arc-extent-label" class="label-cell"></span>
        <span data-name="arc-extent-input"></span>
      </div>

      <br />
      <div data-name="wall-orientation-label" class="card">
      </div>
    </div>
  </div>

  <div id="room-dialog-template" class="dialog-template">
    <div class="room-dialog">
      <h3 class=card>@{RoomPanel.nameAndAreaPanel.title}</h3>
      <div data-name="name-and-area-panel" class=card>
        <span>
          @{RoomPanel.nameLabel.text}
          <input name="name-input" type="text" />
        </span>

        <label>
          <input type="checkbox" name="area-visible-checkbox" />
          @{RoomPanel.areaVisibleCheckBox.text}
        </label>
      </div>

      <div class="columns">
        <div>
          <h3 class=card>@{RoomPanel.floorPanel.title}</h3>
          <div data-name="floor-panel" class="card label-input-grid">

            <div class="whole-line">
              <label>
                <input type="checkbox" name="floor-visible-checkbox" />
                @{RoomPanel.floorVisibleCheckBox.text}
              </label>
            </div>

            <div>
              <label>
                <input type="radio" name="floor-color-and-texture-choice" value="COLORED">
                @{RoomPanel.floorColorRadioButton.text}
              </label>
            </div>
            <div data-name="floor-color-button"></div>

            <div>
              <label>
                <input type="radio" name="floor-color-and-texture-choice" value="TEXTURED">
                @{RoomPanel.floorTextureRadioButton.text}
              </label>
            </div>
            <div data-name="floor-texture-component"></div>

            <div class="whole-line">
              <label>&nbsp;</label>
            </div>

            <div class="whole-line">
              <hr />
            </div>

            <div class="whole-line">
              <label>
                <input type="radio" name="floor-shininess-choice" value="0">
                @{RoomPanel.floorMattRadioButton.text}
              </label>
              <label>
                <input type="radio" name="floor-shininess-choice" value="0.25">
                @{RoomPanel.floorShinyRadioButton.text}
              </label>
            </div>
          </div>
        </div>

        <div>
          <h3 class=card>@{RoomPanel.ceilingPanel.title}</h3>
          <div data-name="ceiling-panel" class="card label-input-grid">

            <div class="whole-line">
              <label>
                <input type="checkbox" name="ceiling-visible-checkbox" />
                @{RoomPanel.ceilingVisibleCheckBox.text}
              </label>
            </div>

            <div>
              <label>
                <input type="radio" name="ceiling-color-and-texture-choice" value="COLORED">
                @{RoomPanel.ceilingColorRadioButton.text}
              </label>
            </div>
            <div data-name="ceiling-color-button"></div>

            <div>
              <label>
                <input type="radio" name="ceiling-color-and-texture-choice" value="TEXTURED">
                @{RoomPanel.ceilingTextureRadioButton.text}
              </label>
            </div>
            <div data-name="ceiling-texture-component"></div>

            <div class="whole-line">
              <label>
                <input type="checkbox" name="ceiling-flat-checkbox" />
                @{RoomPanel.ceilingFlatCheckBox.text}
              </label>
            </div>

            <div class="whole-line">
              <hr />
            </div>

            <div class="whole-line">
              <label>
                <input type="radio" name="ceiling-shininess-choice" value="0">
                @{RoomPanel.ceilingMattRadioButton.text}
              </label>
              <label>
                <input type="radio" name="ceiling-shininess-choice" value="0.25">
                @{RoomPanel.ceilingShinyRadioButton.text}
              </label>
            </div>

          </div>
        </div>

        <div>
          <h3 class="card">@{RoomPanel.wallSidesPanel.title}</h3>
          <div data-name="wall-sides-panel" class="card label-input-grid">

            <div class="whole-line">
              <label title="@{RoomPanel.splitSurroundingWallsCheckBox.tooltip}">
                <input type="checkbox" name="split-surrounding-walls-checkbox" />
                @{RoomPanel.splitSurroundingWallsCheckBox.text}
              </label>
            </div>

            <div>
              <label>
                <input type="radio" name="wall-sides-color-and-texture-choice" value="COLORED">
                @{RoomPanel.wallSidesColorRadioButton.text}
              </label>
            </div>
            <div data-name="wall-sides-color-button"></div>
            <div>
              <label>
                <input type="radio" name="wall-sides-color-and-texture-choice" value="TEXTURED">
                @{RoomPanel.wallSidesTextureRadioButton.text}
              </label>
            </div>
            <div data-name="wall-sides-texture-component"></div>

            <div class="whole-line">
              <label>&nbsp;</label>
            </div>

            <div class="whole-line">
              <hr />
            </div>

            <div class="whole-line">
              <label>
                <input type="radio" name="wall-sides-shininess-choice" value="0">
                @{RoomPanel.wallSidesMattRadioButton.text}
              </label>
              <label>
                <input type="radio" name="wall-sides-shininess-choice" value="0.25">
                @{RoomPanel.wallSidesShinyRadioButton.text}
              </label>
            </div>
          </div>
        </div>

        <div>
          <h3 class="card">@{RoomPanel.wallSidesBaseboardPanel.title}</h3>
          <div data-name="wall-sides-baseboard-panel" class="card">

          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="user-preferences-dialog-template" class="dialog-template">

    <div class="user-preferences-dialog label-input-grid">
      <div>@{UserPreferencesPanel.languageLabel.text}</div>
      <div>
        <select name="language-select"></select>
      </div>

      <div>@{UserPreferencesPanel.unitLabel.text}</div>
      <div>
        <select name="unit-select"></select>
      </div>

      <div>@{UserPreferencesPanel.currencyLabel.text}</div>
      <div>
        <select name="currency-select"></select>

        <label>
          <input type="checkbox" name="value-added-tax-checkbox" />
          @{UserPreferencesPanel.valueAddedTaxCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.furnitureCatalogViewLabel.text}</div>
      <div>
        <label>
          <input type="radio" name="furniture-catalog-view-radio" value="tree" />
          @{UserPreferencesPanel.treeRadioButton.text}
        </label>
        <label>
          <input type="radio" name="furniture-catalog-view-radio" value="list" />
          @{UserPreferencesPanel.listRadioButton.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.navigationPanelLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="navigation-panel-checkbox" />
          @{UserPreferencesPanel.navigationPanelCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.editingIn3DViewLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="editing-in-3D-view-checkbox" />
          @{UserPreferencesPanel.editingIn3DViewCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.aerialViewCenteredOnSelectionLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="aerial-view-centered-on-selection-checkbox" />
          @{UserPreferencesPanel.aerialViewCenteredOnSelectionCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.observerCameraSelectedAtChangeLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="observer-camera-selected-at-change-checkbox" />
          @{UserPreferencesPanel.observerCameraSelectedAtChangeCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.magnetismLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="magnetism-checkbox" />
          @{UserPreferencesPanel.magnetismCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.rulersLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="rulers-checkbox" />
          @{UserPreferencesPanel.rulersCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.gridLabel.text}</div>
      <div>
        <label>
          <input type="checkbox" name="grid-checkbox" />
          @{UserPreferencesPanel.gridCheckBox.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.defaultFontNameLabel.text}</div>
      <div>
        <select name="default-font-name-select">
        </select>
      </div>

      <div>@{UserPreferencesPanel.furnitureIconLabel.text}</div>
      <div>
        <label>
          <input type="radio" name="furniture-icon-radio" value="catalog" />
          @{UserPreferencesPanel.catalogIconRadioButton.text}
        </label>
        <br />
        <label>
          <input type="radio" name="furniture-icon-radio" value="topView" />
          @{UserPreferencesPanel.topViewRadioButton.text}
        </label>
        @{UserPreferencesPanel.iconSizeLabel.text}
        <select name="icon-size-select"></select>
      </div>

      <div>@{UserPreferencesPanel.roomRenderingLabel.text}</div>
      <div>
        <label>
          <input type="radio" name="room-rendering-radio" value="monochrome" />
          @{UserPreferencesPanel.monochromeRadioButton.text}
        </label>
        <label>
          <input type="radio" name="room-rendering-radio" value="floorColorOrTexture" />
          @{UserPreferencesPanel.floorColorOrTextureRadioButton.text}
        </label>
      </div>

      <div>@{UserPreferencesPanel.newWallPatternLabel.text}</div>
      <div data-name="new-wall-pattern-select"></div>

      <div>@{UserPreferencesPanel.newWallThicknessLabel.text}</div>
      <div>
        <span data-name="new-wall-thickness-input"></span>
      </div>
      <div>@{UserPreferencesPanel.newWallHeightLabel.text}</div>
      <div>
        <span data-name="new-wall-height-input"></span>
      </div>
      <div>@{UserPreferencesPanel.newFloorThicknessLabel.text}</div>
      <div>
        <span data-name="new-floor-thickness-input"></span>
      </div>
    </div>
  </div>

  <div id="polyline-dialog-template" class="dialog-template">
    <div class="polyline-dialog label-input-grid">
      <div data-name="thickness-label">
      </div>
      <div>
        <span data-name="thickness-input"></span>
      </div>

      <div>
        @{PolylinePanel.arrowsStyleLabel.text}
      </div>
      <div data-name="arrows-style-select"></div>

      <div>
        @{PolylinePanel.joinStyleLabel.text}
      </div>
      <div data-name="join-style-select"></div>

      <div>
        @{PolylinePanel.dashStyleLabel.text}
      </div>
      <div data-name="dash-style-select"></div>

      <div>
        @{PolylinePanel.dashOffsetLabel.text}
      </div>
      <div>
        <span data-name="dash-offset-input"></span>
      </div>

      <div>
        @{PolylinePanel.colorLabel.text}
      </div>
      <div data-name="color-button"></div>

      <div></div>
      <div>
        <label>
          <input type="checkbox" name="visible-in-3D-checkbox" />
          @{PolylinePanel.visibleIn3DViewCheckBox.text}
        </label>
      </div>
      <div></div>
    </div>
  </div>

  <div id="dimension-line-dialog-template" class="dialog-template">
    <div class="dimension-line-dialog">
      <h3 class="card">@{DimensionLinePanel.startPointPanel.title}</h3>
      <div class="card label-input-grid double">
        <span data-name="x-start-label"></span>
        <span data-name="x-start-input"></span>
        <span data-name="y-start-label"></span>
        <span data-name="y-start-input"></span>
        <span data-name="elevation-start-label"></span>
        <span data-name="elevation-start-input"></span>
      </div>

      <br />
      <h3 class="card">@{DimensionLinePanel.endPointPanel.title}</h3>
      <div class="card label-input-grid double">
        <span data-name="x-end-label"></span>
        <span data-name="x-end-input"></span>
        <span data-name="y-end-label"></span>
        <span data-name="y-end-input"></span>
        <span class="whole-line end-point-addition">
          <span data-name="distance-to-end-point-label"></span>
          <span data-name="distance-to-end-point-input"></span>
        </span>
        <span class="whole-line end-point-addition">
          <span data-name="offset-label"></span>
          <span data-name="offset-input"></span>
        </span>
        <div class="whole-line">
          <hr />
        </div>
        <span class="whole-line orientation">
          <label>
            <input type="radio" name="orientation-choice" value="PLAN">
            @{DimensionLinePanel.planDimensionLineRadioButton.text}
          </label>
          <label>
            <input type="radio" name="orientation-choice" value="ELEVATION">
            @{DimensionLinePanel.elevationDimensionLineRadioButton.text}
          </label>
        </span>
      </div>

      <br />
      <h3 class=card>@{DimensionLinePanel.stylePanel.title}</h3>
      <div data-name="style-panel" class="card label-input-grid">
        <div data-name="length-font-size-label">
        </div>
        <div data-name="length-font-size-input-container">
          <span data-name="length-font-size-input"></span>
        </div>

        <div data-name="color-label">
          @{DimensionLinePanel.colorLabel.text}
        </div>
        <div data-name="color-button"></div>
      </div>

      <br />
      <h3 class=card>@{DimensionLinePanel.rendering3DPanel.title}</h3>
      <div data-name="rendering-3D-panel" class="card label-input-grid">
        <div class="whole-line">
          <label>
            <input type="checkbox" name="visible-in-3D-checkbox" />
            @{DimensionLinePanel.visibleIn3DViewCheckBox.text}
          </label>
        </div>

        <div>
          @{DimensionLinePanel.pitchLabel.text}
        </div>
        <div>
          <label>
            <input type="radio" name="label-pitch-radio" value="0" />
            @{DimensionLinePanel.pitch0DegreeRadioButton.text}
          </label>
          <label>
            <input type="radio" name="label-pitch-radio" value="90" />
            @{DimensionLinePanel.pitch90DegreeRadioButton.text}
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="label-dialog-template" class="dialog-template">
    <div class="label-dialog">
      <h3 class=card>@{LabelPanel.textAndStylePanel.title}</h3>
      <div data-name="text-and-style-panel" class="card label-input-grid">
        <div>
          @{LabelPanel.textLabel.text}
        </div>
        <div>
          <textarea name="text" rows="4"></textarea>
        </div>

        <div>
          @{LabelPanel.alignmentLabel.text}
        </div>
        <div>
          <label>
            <input type="radio" name="label-alignment-radio" value="LEFT" />
            @{LabelPanel.leftAlignmentRadioButton.text}
          </label>
          <label>
            <input type="radio" name="label-alignment-radio" value="CENTER" />
            @{LabelPanel.centerAlignmentRadioButton.text}
          </label>
          <label>
            <input type="radio" name="label-alignment-radio" value="RIGHT" />
            @{LabelPanel.rightAlignmentRadioButton.text}
          </label>
        </div>

        <div>
          @{LabelPanel.fontNameLabel.text}
        </div>
        <div>
          <select name="font-select">
          </select>
        </div>

        <div data-name="font-size-label">
        </div>
        <div data-name="font-size-input-container">
          <span data-name="font-size-input"></span>
        </div>

        <div data-name="color-label">
          @{LabelPanel.colorLabel.text}
        </div>
        <div data-name="color-button"></div>
      </div>

      <br />
      <h3 class=card>@{LabelPanel.rendering3DPanel.title}</h3>
      <div data-name="rendering-3D-panel" class="card label-input-grid">
        <div class="whole-line">
          <label>
            <input type="checkbox" name="visible-in-3D-checkbox" />
            @{LabelPanel.visibleIn3DViewCheckBox.text}
          </label>
        </div>

        <div>
          @{LabelPanel.pitchLabel.text}
        </div>
        <div>
          <label>
            <input type="radio" name="label-pitch-radio" value="0" />
            @{LabelPanel.pitch0DegreeRadioButton.text}
          </label>
          <label>
            <input type="radio" name="label-pitch-radio" value="90" />
            @{LabelPanel.pitch90DegreeRadioButton.text}
          </label>
        </div>

        <div data-name="elevation-label">
        </div>
        <div>
          <span data-name="elevation-input"></span>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var urlBase = window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1);
    console.log('üîß Initializing SweetHome3D with urlBase:', urlBase);

    var application = new SweetHome3DJSApplication(
      {
        readHomeURL: urlBase + "data/%s.sh3x",
        writeHomeURL: urlBase + "writeData.php?path=%s.sh3x",
        writeResourceURL: urlBase + "writeData.php?path=%s",
        readResourceURL: urlBase + "data/%s",
        listHomesURL: urlBase + "listHomes.php",
        deleteHomeURL: urlBase + "deleteHome.php?home=%s",
        writePreferencesURL: urlBase + "writeData.php?path=userPreferences.json",
        readPreferencesURL: urlBase + "data/userPreferences.json", furnitureCatalogURLs: [
          urlBase + "lib/resources/DefaultFurnitureCatalog.json"
        ],
        furnitureResourcesURLBase: urlBase,
        texturesCatalogURLs: [urlBase + "lib/resources/DefaultTexturesCatalog.json"],
        texturesResourcesURLBase: urlBase,
        writeHomeWithWorker: true,
        compressionLevel: 5,
        autoRecovery: true,
        defaultHomeName: "home-d78b0c75-7b64-4a70-a722-37c8dd6a2b81"
      });

    console.log('‚úÖ SweetHome3D application initialized');

    setTimeout(function () {
      console.log('üè† Adding default home...');
      application.addHome(application.createHome());
      console.log('‚úÖ Default home added');
    }, 500);
  </script>
  <!-- Home Assistant Smart Device Integration -->
  <script type="text/javascript">
    (function () {
      'use strict';

      // Add this instead:
      window.addEventListener('load', function() {
        setTimeout(function() {
          initHAIntegration();
          addExportButtons();  // Floating buttons (always visible)
          addExportKeyboardShortcuts();  // Ctrl+E shortcuts
          initHAEntityField();  // Initialize HA entity ID field in furniture dialog
        }, 1000);
      });
  
      function initHAIntegration() {
        console.log('üè† Initializing Home Assistant integration...');

        // Wait a bit longer for the application to fully initialize
        setTimeout(() => {
          // Add Export menu item (will be added when menus are created)

          // Add device counter UI element
          addDeviceCounter();

          // Check if HA devices are loaded in the furniture catalog
          checkHADevicesLoaded();
        }, 2000); // Increased delay to 2 seconds
      }

      
      // TODO: CHECK LATER - Canvas 2D effect radius renderer not working, commented out for now
      /*
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for SweetHome3D to fully initialize
        const initEffectRenderer = () => {
          if (!window.application || !window.application.getHomes) {
            console.log('‚è≥ Waiting for application...');
            setTimeout(initEffectRenderer, 500);
            return;
          }
          
          const homes = window.application.getHomes();
          if (!homes || homes.length === 0) {
            console.log('‚è≥ Waiting for home to be created...');
            setTimeout(initEffectRenderer, 500);
            return;
          }
          
          console.log('üé® Initializing Effect Radius Renderer');
          
          // Create renderer instance
          window.effectRadiusRenderer = new EffectRadiusRenderer();
          window.effectRadiusRenderer.initialize(window.application);
          
          // Auto-detect existing IoT devices
          const home = homes[0];
          if (home) {
            const count = window.effectRadiusRenderer.autoDetectDevices(home);
            
            // Add a test device if none found
            if (count === 0) {
              console.log('‚ö†Ô∏è No IoT devices found. Adding test devices...');
              const furniture = home.getFurniture();
              if (furniture && furniture.length > 0) {
                // Add different propagation types for demo
                const TYPES = window.effectRadiusRenderer.PROPAGATION_TYPES;
                
                if (furniture[0]) {
                  window.effectRadiusRenderer.addDevice(
                    furniture[0], 5.0, 'rgba(255, 0, 0, 0.5)', 
                    TYPES.ROOM_FILL
                  );
                  console.log('‚úì Test device 1: ROOM_FILL (temperature-like)');
                }
                
                if (furniture[1]) {
                  window.effectRadiusRenderer.addDevice(
                    furniture[1], 4.0, 'rgba(0, 255, 0, 0.5)', 
                    TYPES.CIRCULAR
                  );
                  console.log('‚úì Test device 2: CIRCULAR (motion sensor-like)');
                }
                
                if (furniture[2]) {
                  window.effectRadiusRenderer.addDevice(
                    furniture[2], 3.0, 'rgba(0, 0, 255, 0.5)', 
                    TYPES.SQUARE
                  );
                  console.log('‚úì Test device 3: SQUARE (grid-based)');
                }
              }
            }
          }
          
          // Debug status after 2 seconds
          setTimeout(() => {
            if (window.effectRadiusRenderer) {
              window.effectRadiusRenderer.debugStatus();
            }
          }, 2000);
          
          console.log('‚úÖ Effect Radius Renderer ready');
          console.log('üí° Use window.effectRadiusRenderer.debugStatus() to check status');
          
          // Add toggle button to toolbar (optional)
          addEffectRadiusToggle();
        };
        
        initEffectRenderer();
      });

      /**
       * Add toggle button to show/hide effect radii
       */
      function addEffectRadiusToggle() {
        const toolbar = document.querySelector('.toolbar');
        if (!toolbar) return;
        
        const button = document.createElement('button');
        button.textContent = 'üì° Effect Radii';
        button.className = 'toolbar-button';
        button.style.marginLeft = '10px';
        button.title = 'Toggle IoT device effect radii visualization';
        
        let enabled = true;
        button.onclick = () => {
          enabled = !enabled;
          window.effectRadiusRenderer.setEnabled(enabled);
          button.style.opacity = enabled ? '1.0' : '0.5';
        };
        
        toolbar.appendChild(button);
      }
      

          /**
     * Add floating export buttons to the interface
     */
    function addExportButtons() {
      // Create button container
      const buttonContainer = document.createElement('div');
      buttonContainer.id = 'export-button-container';
      buttonContainer.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      `;
      
      // Create "Export for Unity" button
      const unityButton = document.createElement('button');
      unityButton.id = 'export-unity-btn';
      unityButton.innerHTML = 'üì¶ Export for Unity';
      unityButton.style.cssText = `
        background: #4CAF50;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: all 0.3s;
      `;
      unityButton.onmouseover = function() {
        this.style.background = '#45a049';
        this.style.transform = 'scale(1.05)';
      };
      unityButton.onmouseout = function() {
        this.style.background = '#4CAF50';
        this.style.transform = 'scale(1)';
      };
      unityButton.onclick = function() {
        exportForUnity();
      };
      
      // Create "Export to OBJ" button
      const objButton = document.createElement('button');
      objButton.id = 'export-obj-btn';
      objButton.innerHTML = 'üî∑ Export to OBJ';
      objButton.style.cssText = `
        background: #2196F3;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: all 0.3s;
      `;
      objButton.onmouseover = function() {
        this.style.background = '#1976D2';
        this.style.transform = 'scale(1.05)';
      };
      objButton.onmouseout = function() {
        this.style.background = '#2196F3';
        this.style.transform = 'scale(1)';
      };
      objButton.onclick = function() {
        exportToOBJ();
      };
      
      // Add buttons to container
      buttonContainer.appendChild(unityButton);
      buttonContainer.appendChild(objButton);
      
      // Add to page
      document.body.appendChild(buttonContainer);
      
      console.log('‚úÖ Export buttons added to interface');
    }

 
    /**
   * Add keyboard shortcuts for export
   */
  function addExportKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Ctrl+E or Cmd+E for Unity export
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportForUnity();
      }
      
      // Ctrl+Shift+E or Cmd+Shift+E for OBJ export
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
        e.preventDefault();
        exportToOBJ();
      }
    });
    
    console.log('‚úÖ Export keyboard shortcuts added');
    console.log('   Ctrl+E: Export for Unity');
    console.log('   Ctrl+Shift+E: Export to OBJ');
  }

      /**
     * Check if HA devices are loaded in the furniture catalog
     */
      function checkHADevicesLoaded() {
        console.log('üîç Checking for HA devices in furniture catalog...');

        setTimeout(() => {
          try {
            if (window.application && window.application.getUserPreferences) {
              const prefs = window.application.getUserPreferences();
              if (prefs && prefs.getFurnitureCatalog) {
                const catalog = prefs.getFurnitureCatalog();
                if (catalog && catalog.getCategories) {
                  const categories = catalog.getCategories();
                  console.log('üìÇ Total categories found:', categories.length);

                  // Look for Smart device categories
                  let smartCategoriesCount = 0;
                  let smartDevicesCount = 0;

                  categories.forEach(category => {
                    const categoryName = category.getName ? category.getName() : category;
                    console.log('  üìÅ Category:', categoryName);

                    if (categoryName.includes('Smart')) {
                      smartCategoriesCount++;
                      console.log('    ‚úÖ Found Smart category:', categoryName);

                      // Count devices in this category
                      try {
                        const furniture = category.getFurniture ? category.getFurniture() : [];
                        smartDevicesCount += furniture.length;
                        console.log('    üì¶ Smart devices in category:', furniture.length);
                      } catch (e) {
                        console.log('    ‚ö†Ô∏è Could not count devices in category:', e.message);
                      }
                    }
                  });

                  if (smartCategoriesCount > 0) {
                    console.log(`‚úÖ HA integration successful! Found ${smartCategoriesCount} Smart categories with ${smartDevicesCount} devices`);
                    showNotification(`‚úÖ Smart Home devices loaded! Found ${smartDevicesCount} devices in ${smartCategoriesCount} categories.`, 'success');
                  } else {
                    console.warn('‚ö†Ô∏è No Smart device categories found in furniture catalog');
                    showNotification('‚ö†Ô∏è Smart device categories not found. Check DefaultFurnitureCatalog.json', 'warning');
                  }
                }
              }
            }
          } catch (e) {
            console.error('‚ùå Error checking HA devices:', e);
            showNotification('‚ùå Error checking smart devices: ' + e.message, 'error');
          }
        }, 3000); // Wait 3 seconds for catalog to load
      }
      /**
       * Initialize HA Entity ID field in furniture dialog
       * Wires up the input field to read/write the 'haEntityId' property
       */
      function initHAEntityField() {
        console.log('üîß Initializing HA Entity ID field integration...');
        
        // Poll for dialog opening (when furniture is double-clicked)
        setInterval(() => {
          setupHAEntityField();
        }, 500);
        
        console.log('‚úÖ HA Entity ID field initialization complete');
        console.log('‚ÑπÔ∏è  To use: Double-click furniture ‚Üí Enter entity_id in "üè† HA Entity ID" field');
        console.log('‚ÑπÔ∏è  Debug: Run setupHAEntityField() in console to manually check');
        
        // Expose for debugging
        window.setupHAEntityField = setupHAEntityField;
        window.getFurnitureController = getFurnitureController;
        window.isSmartDeviceFurniture = isSmartDeviceFurniture;
      }
      
      /**
       * Setup the HA entity field when furniture dialog is shown
       */
      function setupHAEntityField() {
        // Find the HA entity input field
        const haEntityInput = document.querySelector('input[name="ha-entity-input"]');
        const haEntityLabel = document.querySelector('[data-name="ha-entity-label"]');
        const haEntityContainer = document.querySelector('[data-name="ha-entity-input-container"]');
        
        if (!haEntityInput || !haEntityLabel || !haEntityContainer) {
          return; // Dialog not open yet
        }
        
        // Get the controller (furniture being edited)
        const controller = getFurnitureController();
        if (!controller) {
          // Hide field if no furniture
          haEntityLabel.style.display = 'none';
          haEntityContainer.style.display = 'none';
          haEntityInput.dataset.initialized = 'false';
          return;
        }
        
        // Check if this is a smart device (ha_ prefix in catalog ID)
        const catalogId = controller.getCatalogId ? controller.getCatalogId() : '';
        const isSmartDevice = isSmartDeviceFurniture(controller);
        
        // Debug logging
        if (haEntityInput.dataset.debugLogged !== 'true') {
          console.log('üîç Dialog detected:');
          console.log('  - Catalog ID:', catalogId);
          console.log('  - Is Smart Device:', isSmartDevice);
          haEntityInput.dataset.debugLogged = 'true';
        }
        
        if (!isSmartDevice) {
          // Hide field for non-smart devices
          haEntityLabel.style.display = 'none';
          haEntityContainer.style.display = 'none';
          haEntityInput.dataset.initialized = 'false';
          haEntityInput.dataset.debugLogged = 'false'; // Reset for next dialog
          return;
        }
        
        // Check if already initialized
        if (haEntityInput.dataset.initialized === 'true') {
          return;
        }
        
        console.log('üîß Setting up HA Entity ID field for smart device...');
        console.log('  - Showing field elements');
        
        // Show the field (only for smart devices) - remove display:none to use default grid layout
        haEntityLabel.style.display = '';
        haEntityContainer.style.display = '';
        
        console.log('  - Label display now:', haEntityLabel.style.display || 'default');
        console.log('  - Container display now:', haEntityContainer.style.display || 'default');
        
        // Read current HA entity ID from furniture properties
        const currentEntityId = getHAEntityId(controller);
        haEntityInput.value = currentEntityId || '';
        
        console.log('üìã Current HA entity ID:', currentEntityId || '(none)');
        
        // Store the controller reference on the input element
        haEntityInput.haController = controller;
        
        // Instead of saving on input, we'll save on dialog close
        // Remove any existing blur listener first
        if (!haEntityInput.hasBlurListener) {
          haEntityInput.addEventListener('change', function() {
            const newValue = haEntityInput.value.trim();
            console.log('‚úèÔ∏è HA entity ID field changed to:', newValue || '(empty)');
            // Save immediately on change
            if (haEntityInput.haController) {
              setHAEntityId(haEntityInput.haController, newValue);
            }
          });
          haEntityInput.hasBlurListener = true;
        }
        
        // Mark as initialized
        haEntityInput.dataset.initialized = 'true';
        
        console.log('‚úÖ HA Entity ID field setup complete');
      }
      
      /**
       * Check if furniture is a smart device (has ha_ prefix)
       */
      function isSmartDeviceFurniture(furniture) {
        try {
          if (!furniture) return false;
          
          // Check main catalog ID for ha_ prefix
          const catalogId = furniture.getCatalogId ? furniture.getCatalogId() : '';
          if (catalogId && catalogId.indexOf('ha_') === 0) {
            return true;
          }
          
          // Check properties.catalogId for ha_ prefix (for custom created devices)
          try {
            if (furniture.properties && furniture.properties.catalogId) {
              const propsCatalogId = furniture.properties.catalogId;
              if (propsCatalogId && propsCatalogId.indexOf('ha_') === 0) {
                console.log('‚úÖ Detected smart device from properties.catalogId:', propsCatalogId);
                return true;
              }
            }
          } catch (e) {
            // Properties might not be accessible, continue
          }
          
          // Check if creator is "HA" (Home Assistant created devices)
          try {
            if (furniture.creator && furniture.creator === 'HA') {
              console.log('‚úÖ Detected smart device from creator: HA');
              return true;
            }
          } catch (e) {
            // Creator might not be accessible, continue
          }
          
          // Also check category name
          if (typeof furniture.getCategory === 'function') {
            const category = furniture.getCategory();
            if (category) {
              const categoryName = category.getName ? category.getName() : '';
              if (categoryName && categoryName.toLowerCase().includes('smart')) {
                return true;
              }
            }
          }
          
          return false;
        } catch (e) {
          console.log('‚ÑπÔ∏è Could not determine if furniture is smart device:', e.message);
          return false;
        }
      }
      
      /**
       * Get the furniture controller from the current dialog
       */
      function getFurnitureController() {
        try {
          // Try to access the application's home and selected items
          if (!window.application) return null;
          
          const homes = window.application.getHomes();
          if (!homes || homes.length === 0) return null;
          
          const home = homes[0];
          const selectedItems = home.getSelectedItems();
          
          if (!selectedItems || selectedItems.length === 0) return null;
          
          // Find the first furniture piece
          for (let i = 0; i < selectedItems.length; i++) {
            const item = selectedItems[i];
            // Check if it's a piece of furniture (has getCatalogId method)
            if (item && typeof item.getCatalogId === 'function') {
              return item;
            }
          }
          
          return null;
        } catch (e) {
          console.error('Error getting furniture controller:', e);
          return null;
        }
      }
      
      /**
       * Get HA entity ID from furniture properties
       */
      function getHAEntityId(furniture) {
        try {
          if (!furniture || typeof furniture.getProperty !== 'function') {
            console.log('‚ö†Ô∏è Cannot get HA entity ID - furniture missing or no getProperty method');
            return null;
          }
          
          // Try to get the property
          const entityId = furniture.getProperty('haEntityId');
          console.log('üîç Retrieved HA entity ID from property:', entityId);
          
          // Also log all properties for debugging
          if (typeof furniture.getPropertyNames === 'function') {
            const propertyNames = furniture.getPropertyNames();
            console.log('üìù All furniture properties:', propertyNames);
          }
          
          return entityId;
        } catch (e) {
          console.log('‚ÑπÔ∏è No HA entity ID found on furniture:', e.message);
          return null;
        }
      }
      
      /**
       * Set HA entity ID on controller's additional properties
       * This ensures it will be saved when the dialog OK button is clicked
       */
      function setHAEntityId(controller, entityId) {
        try {
          if (!controller) {
            console.error('‚ùå No controller object to set entity ID on');
            return;
          }
          
          console.log('üíæ Setting HA entity ID on controller:', entityId);
          
          // Get current additional properties
          let additionalProps = controller.getAdditionalProperties();
          console.log('üìã Current additional properties:', additionalProps);
          
          // Initialize if null
          if (!additionalProps) {
            additionalProps = { entries: [] };
          }
          
          // Ensure entries array exists
          if (!additionalProps.entries) {
            additionalProps.entries = [];
          }
          
          // Find or create the haEntityId entry
          let found = false;
          for (let i = 0; i < additionalProps.entries.length; i++) {
            const entry = additionalProps.entries[i];
            if (entry.key === 'haEntityId' || (entry.key && entry.key.getName && entry.key.getName() === 'haEntityId')) {
              // Update existing entry
              if (entityId && entityId.length > 0) {
                entry.value = entityId;
                console.log('‚úÖ Updated existing HA entity ID entry:', entityId);
              } else {
                // Remove entry if empty
                additionalProps.entries.splice(i, 1);
                console.log('üóëÔ∏è Removed empty HA entity ID entry');
              }
              found = true;
              break;
            }
          }
          
          // Add new entry if not found
          if (!found && entityId && entityId.length > 0) {
            additionalProps.entries.push({
              key: 'haEntityId',
              value: entityId,
              getKey: function() { return this.key; },
              getValue: function() { return this.value; }
            });
            console.log('‚úÖ Added new HA entity ID entry:', entityId);
          }
          
          // Update the controller's additional properties
          controller.setAdditionalProperties(additionalProps.entries.length > 0 ? additionalProps : null);
          console.log('ÔøΩ Saved to controller additional properties');
          
          // Verify
          const verify = controller.getAdditionalProperties();
          console.log('üîç Verification - controller properties:', verify);
        } catch (e) {
          console.error('‚ùå Error setting HA entity ID:', e);
        }
      }
      
      /**
     * Wait for application to be ready
     */
      function waitForApplication(callback, attempts = 0) {
        if (attempts > 50) { // Max 5 seconds
          console.error('‚ùå Timeout waiting for application');
          return;
        }

        if (window.application && window.application.getUserPreferences) {
          callback();
        } else {
          setTimeout(() => waitForApplication(callback, attempts + 1), 100);
        }
      }

      /**
       * Refresh furniture library UI
       */
      function refreshFurnitureLibrary() {
        try {
          // Try to find and refresh the furniture library component
          if (window.application && window.application.getFurnitureLibrary) {
            const library = window.application.getFurnitureLibrary();
            if (library && library.repaint) {
              library.repaint();
              console.log('üîÑ Refreshed furniture library UI');
            }
          }
        } catch (e) {
          console.log('‚ÑπÔ∏è Could not refresh furniture library UI:', e.message);
        }
      }

    /**
     * Export floor plan with device data for Unity
     * Uses UnityExportUtilities class from unity-export-utils.js
     */
    async function exportForUnity() {
      console.log('üì§ Starting Unity export...');
      
      if (!window.application) {
        showError('Application not ready');
        return;
      }
      
      // Check if UnityExportUtilities is loaded
      if (typeof UnityExportUtilities === 'undefined') {
        showError('Unity export utilities not loaded. Please refresh the page.');
        console.error('UnityExportUtilities class not found');
        return;
      }
      
      try {
        const homes = window.application.getHomes();
        
        if (!homes || homes.length === 0) {
          showError('No home loaded');
          return;
        }
        
        const home = homes[0];
        const homeName = home.getName ? home.getName() : 'smart-home';
        
        // Count smart devices (using ha_ prefix check)
        const deviceCount = countHADevices(home);
        
        if (deviceCount === 0) {
          const proceed = confirm(
            'No smart devices found in the floor plan.\n\n' +
            'Add smart devices from the "Smart Devices" category in the furniture catalog before exporting.\n\n' +
            'Export anyway?'
          );
          if (!proceed) return;
        }
        
        showLoading('Exporting for Unity: 3D model, device data, and Unity import script...');
        
        // Use UnityExportUtilities for complete export
        const result = await UnityExportUtilities.exportForUnity(
          home,
          window.homeComponent3D || null,
          homeName
        );
        
        hideLoading();
        
        // Show success message
        const message = `Unity export complete!\n\n` +
          `üì¶ 3D Geometry: ${homeName}_geometry.zip\n` +
          `   - ${result.geometry.vertices} vertices\n` +
          `   - ${result.geometry.faces} faces\n` +
          `   - ${result.geometry.materials} materials\n\n` +
          `üìã Device Data: ${homeName}_devices.json\n` +
          `   - ${result.devices} smart device${result.devices !== 1 ? 's' : ''}\n` +
          `   - ${result.rooms} room${result.rooms !== 1 ? 's' : ''}\n\n` +
          `üìú Unity Import Script: ${homeName}_Import.cs\n\n` +
          `Import all files into Unity for your digital twin.`;
        
        showNotification(message, 'success');
        console.log('‚úÖ Unity export complete:', result);
        
      } catch (e) {
        hideLoading();
        showError('Unity export failed: ' + e.message);
        console.error('‚ùå Unity export error:', e);
        console.error('Stack trace:', e.stack);
      }
    }


    /**
 * Export 3D scene to OBJ format using the complete exporter
 */
async function exportToOBJ() {
  console.log('üì¶ Starting OBJ export with complete exporter...');
  
  if (!window.application) {
    showError('Application not ready');
    console.error('‚ùå window.application is not available');
    return;
  }
  
  try {
    const homes = window.application.getHomes();
    console.log('Found homes:', homes ? homes.length : 0);
    
    if (!homes || homes.length === 0) {
      showError('No home loaded. Please create or open a home first.');
      return;
    }
    
    const home = homes[0];
    const homeName = home.getName ? home.getName() : 'smart-home';
    
    console.log('üìã Home details:');
    console.log('  - Name:', homeName);
    console.log('  - Has getWalls:', typeof home.getWalls === 'function');
    console.log('  - Has getRooms:', typeof home.getRooms === 'function');
    console.log('  - Has getFurniture:', typeof home.getFurniture === 'function');
    
    // Try to count elements
    if (home.getWalls) {
      const walls = home.getWalls();
      console.log('  - Walls:', walls ? walls.length : 0);
    }
    if (home.getRooms) {
      const rooms = home.getRooms();
      console.log('  - Rooms:', rooms ? rooms.length : 0);
    }
    if (home.getFurniture) {
      const furniture = home.getFurniture();
      console.log('  - Furniture:', furniture ? furniture.length : 0);
    }
    
    showLoading('Exporting 3D model to OBJ...');
    
    // Use the complete OBJ exporter
    const exporter = new OBJExporter();
    const result = await exporter.exportToOBJ(
      home, 
      window.homeComponent3D || null, 
      homeName + '.zip'
    );
    
    hideLoading();
    
    console.log('‚úÖ OBJ export complete:', result);
    showNotification(`Export successful! ${result.vertices} vertices, ${result.faces} faces`, 'success');
    
  } catch (e) {
    hideLoading();
    showError('OBJ export failed: ' + e.message);
    console.error('‚ùå OBJ export error:', e);
    console.error('Stack trace:', e.stack);
  }
}

      /**
       * Serialize home to JSON
       */
      function serializeHome(home) {
        const data = {
          furniture: [],
          rooms: [],
          walls: []
        };

        // Serialize furniture (including devices)
        if (home.getFurniture) {
          const furniture = home.getFurniture();
          for (let i = 0; i < furniture.length; i++) {
            const piece = furniture[i];
            
            // Get HA entity ID if present
            let haEntityId = null;
            try {
              if (typeof piece.getProperty === 'function') {
                haEntityId = piece.getProperty('haEntityId');
              }
            } catch (e) {
              // Property doesn't exist, that's ok
            }
            
            const furnitureData = {
              catalogId: piece.getCatalogId ? piece.getCatalogId() : '',
              name: piece.getName ? piece.getName() : '',
              x: piece.getX ? piece.getX() : 0,
              y: piece.getY ? piece.getY() : 0,
              elevation: piece.getElevation ? piece.getElevation() : 0,
              angle: piece.getAngle ? piece.getAngle() : 0
            };
            
            // Add HA entity ID if present
            if (haEntityId) {
              furnitureData.haEntityId = haEntityId;
            }
            
            data.furniture.push(furnitureData);
          }
        }

        // Serialize rooms
        if (home.getRooms) {
          const rooms = home.getRooms();
          for (let i = 0; i < rooms.length; i++) {
            const room = rooms[i];
            const points = [];

            if (room.getPoints) {
              const roomPoints = room.getPoints();
              for (let j = 0; j < roomPoints.length; j++) {
                points.push([roomPoints[j][0], roomPoints[j][1]]);
              }
            }

            data.rooms.push({
              name: room.getName ? room.getName() : '',
              points: points,
              area: room.getArea ? room.getArea() : 0,
              level: room.getLevel ? { name: room.getLevel().getName() } : { name: 'Ground Floor' }
            });
          }
        }

        // Serialize walls
        if (home.getWalls) {
          const walls = home.getWalls();
          for (let i = 0; i < walls.length; i++) {
            const wall = walls[i];
            data.walls.push({
              xStart: wall.getXStart ? wall.getXStart() : 0,
              yStart: wall.getYStart ? wall.getYStart() : 0,
              xEnd: wall.getXEnd ? wall.getXEnd() : 0,
              yEnd: wall.getYEnd ? wall.getYEnd() : 0,
              height: wall.getHeight ? wall.getHeight() : 250,
              thickness: wall.getThickness ? wall.getThickness() : 10
            });
          }
        }

        return JSON.stringify(data);
      }

      /**
       * Count HA devices in home
       */
      function countHADevices(home) {
        let count = 0;

        if (home.getFurniture) {
          const furniture = home.getFurniture();
          for (let i = 0; i < furniture.length; i++) {
            const piece = furniture[i];
            const catalogId = piece.getCatalogId ? piece.getCatalogId() : '';
            
            // Use same detection logic as UnityExportUtilities.isIoTDevice
            if (UnityExportUtilities.isIoTDevice(catalogId, piece)) {
              count++;
            }
          }
        }

        return count;
      }

      /**
       * Show export success dialog
       */
      function showExportSuccessDialog(result) {
        let message = '‚úÖ Export successful!\n\n';
        message += 'Devices exported: ' + result.devices_count + '\n';
        message += 'Rooms: ' + result.rooms_count + '\n\n';
        message += 'Files saved:\n';
        message += '‚Ä¢ ' + result.latest_path + '\n';
        message += '‚Ä¢ ' + result.export_path + '\n';

        if (result.ha_path_copied) {
          message += '\n‚úì Copied to Home Assistant (/config/www/models/)';
        }

        if (result.devices && result.devices.length > 0) {
          message += '\n\nDevices:\n';
          result.devices.forEach(function (device) {
            message += '‚Ä¢ ' + device.name + ' (' + device.type + ')\n';
          });
        }

        alert(message);
        console.log('‚úÖ Export complete:', result);
      }

      /**
       * Add device counter to UI
       */
      function addDeviceCounter() {
        // Add counter element to toolbar or catalog panel
        const catalogPane = document.getElementById('catalog-furniture-pane');
        if (catalogPane) {
          const counter = document.createElement('div');
          counter.id = 'ha-device-counter';
          counter.style.cssText = 'position: absolute; bottom: 5px; right: 5px; ' +
            'background: #4CAF50; color: white; padding: 5px 10px; ' +
            'border-radius: 3px; font-size: 11px; z-index: 100;';
          counter.textContent = '0 smart devices';
          catalogPane.appendChild(counter);

          // Update counter periodically
          setInterval(updateDeviceCounter, 2000);
        }
      }

    
    /**
     * Update device counter
     */
    function updateDeviceCounter() {
      const counter = document.getElementById('ha-device-counter');
      if (!counter || !window.application) return;
      
      try {
        const homes = window.application.getHomes();  // ‚Üê Changed to getHomes()
        if (homes && homes.length > 0) {
          const home = homes[0];
          const count = countHADevices(home);
          counter.textContent = count + ' smart device' + (count !== 1 ? 's' : '');
          counter.style.background = count > 0 ? '#4CAF50' : '#999';
        }
      } catch (e) {
        console.error('Error updating device counter:', e);
      }
    }

        /**
     * Add Export menu item (if menu exists)
     */
    function addExportMenuItem() {
      const checkMenu = setInterval(function () {
        if (window.application && window.application.getMenuBar) {
          clearInterval(checkMenu);
          
          try {
            const menuBar = window.application.getMenuBar();
            if (menuBar) {
              const menus = menuBar.getSubElements ? menuBar.getSubElements() : [];
              
              for (let i = 0; i < menus.length; i++) {
                const menu = menus[i];
                if (menu.getText && menu.getText().includes('File')) {
                  
                  const exportUnityItem = {
                    text: 'Export for Unity...',
                    action: function () {
                      exportForUnity();
                    }
                  };
                  
                  const exportOBJItem = {
                    text: 'Export to OBJ...',
                    action: function () {
                      exportToOBJ();
                    }
                  };
                  
                  if (menu.addSeparator) {
                    menu.addSeparator();
                  }
                  if (menu.add) {
                    menu.add(exportUnityItem);
                    menu.add(exportOBJItem);
                  }
                  
                  console.log('‚úÖ Export menu items added');
                  break;
                }
              }
            }
          } catch (e) {
            console.error('Error adding menu items:', e);
          }
        }
      }, 500);
        setTimeout(function () {
          clearInterval(checkMenu);
        }, 10000);
      }

      /**
     * UI Helper functions
     */
      function showNotification(message, type) {
        console.log('[' + type + '] ' + message);

        // Create a simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; ' +
          'padding: 12px 20px; border-radius: 4px; color: white; font-size: 14px; ' +
          'max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';

        switch (type) {
          case 'success':
            toast.style.backgroundColor = '#4CAF50';
            break;
          case 'warning':
            toast.style.backgroundColor = '#FF9800';
            break;
          case 'error':
            toast.style.backgroundColor = '#F44336';
            break;
          default:
            toast.style.backgroundColor = '#2196F3';
        }

        toast.textContent = message;
        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 5000);
      }

      function showLoading(message) {
        // Create loading overlay
        const overlay = document.createElement('div');
        overlay.id = 'ha-loading-overlay';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; ' +
          'background: rgba(0,0,0,0.7); z-index: 10000; ' +
          'display: flex; align-items: center; justify-content: center;';

        const spinner = document.createElement('div');
        spinner.style.cssText = 'background: white; padding: 30px; border-radius: 8px; ' +
          'text-align: center;';
        spinner.innerHTML = '<div style="font-size: 18px; margin-bottom: 10px;">‚è≥</div>' +
          '<div>' + message + '</div>';

        overlay.appendChild(spinner);
        document.body.appendChild(overlay);
      }

      function hideLoading() {
        const overlay = document.getElementById('ha-loading-overlay');
        if (overlay) {
          overlay.remove();
        }
      }

      function showError(message) {
        alert('‚ùå Error: ' + message);
        console.error('Error:', message);
      }

      console.log('‚úÖ HA Integration script loaded');
    })();
  </script>
</body>

</html>